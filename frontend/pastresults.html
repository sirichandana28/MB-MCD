<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Past Results | CropCare AI</title>
  <link rel="stylesheet" href="static/style.css" />
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f7f8fa;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #2b6cb0;
      margin-bottom: 10px;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    button {
      background: #2b6cb0;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #1e4e8c; }
    .results-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 16px;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-4px); }
    .filename {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      word-break: break-all;
    }
    .prediction { color: #555; line-height: 1.6; }
    .empty-message, .error-message {
      text-align: center;
      color: #666;
      margin-top: 40px;
      font-size: 1.1em;
    }
    .error-message { color: #c53030; }
    .qa {
      margin-top: 8px;
      padding: 10px;
      background: #f1f5fb;
      border-radius: 10px;
    }
    .muted { opacity: .75; font-size: .9em; }
  </style>
</head>
<body>
  <h2>Past Results</h2>

  <div class="buttons">
    <button onclick="window.location.href='index.html'">â¬… Back to Home</button>
    <button onclick="clearHistory()">ðŸ§¹ Clear History</button>
  </div>

  <div class="results-container" id="results"></div>

  <script>
    const username = localStorage.getItem("username"); // set on login

    if (!username) {
      alert("Please log in to view your history.");
      window.location.href = "login.html";
    }

    const container = document.getElementById("results");

    function fmtDate(v) {
      try {
        if (!v) return "â€”";
        if (typeof v === "object" && "$date" in v) return new Date(v["$date"]).toLocaleString();
        return new Date(v).toLocaleString();
      } catch {
        return "â€”";
      }
    }

    async function loadResults() {
      container.innerHTML = "<p class='empty-message'>Loading...</p>";

      try {
        const res = await fetch(`/api/past-results?username=${encodeURIComponent(username)}`);
        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<p class="error-message">${data.message || "Failed to load results."}</p>`;
          return;
        }

        container.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p class='empty-message'>No past results found.</p>";
          return;
        }

        data.forEach(r => {
          const rec = r.record || {};
          const p   = r.prediction || {};
          const crop = rec.crop || p.crop || "â€”";
          const disease = rec.disease_name || p.disease || "â€”";
          const conf = (p.confidence != null ? p.confidence : rec.confidence) ?? "N/A";

          const qaType = rec.qa_type ? ` <span class="muted">(${rec.qa_type})</span>` : "";
          const qaBlock = rec.qa_answer
            ? `<div class="qa"><b>Answer${qaType}:</b><br><pre style="white-space:pre-wrap;margin:4px 0 0 0;">${rec.qa_answer}</pre></div>`
            : "";

          const created = fmtDate(r.createdAt);

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="filename">${r.filename || rec.image_id || "â€”"}</div>
            <div class="prediction">
              <p><b>Crop:</b> ${crop}</p>
              <p><b>Disease:</b> ${disease}</p>
              <p><b>Confidence:</b> ${conf}%</p>
              <p><b>Detected on:</b> ${created}</p>
              ${qaBlock}
            </div>
          `;
          container.appendChild(card);
        });

      } catch (err) {
        console.error("Error fetching past results:", err);
        container.innerHTML = "<p class='error-message'>Failed to load results. Please try again.</p>";
      }
    }

    async function clearHistory() {
      if (!confirm("Are you sure you want to delete all past results?")) return;

      try {
        const res = await fetch(`/api/clear-history?username=${encodeURIComponent(username)}`, { method: "DELETE" });
        const data = await res.json();

        if (!res.ok) {
          alert(data.message || "Failed to clear history.");
          return;
        }
        alert(data.message);
        loadResults();

      } catch (err) {
        console.error("Error clearing history:", err);
        alert("Failed to clear history.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadResults);
  </script>
</body>
</html>
